000100 IDENTIFICATION DIVISION.
000200 PROGRAM-ID. DB2PART2.
000300 AUTHOR. GROUP4.
000400*=============================================================
000500* PROGRAMME DB2PART2 - TRAITEMENT DES COMMANDES ET STOCKS
000600* OBJECTIF PRINCIPAL :
000700* 1. FUSIONNER 2 FICHIERS DE VENTES (EU/AS) PAR ID COMMANDE
000800* 2. INSERER LES COMMANDES/ITEMS EN BASE DB2 (ORDERS/ITEMS)
000900* 3. METTRE A JOUR LES BALANCES CLIENTS (CUSTOMERS)
001000* 4. RECALCULER LES STOCKS PRODUITS (PRODUCTS)
001100* 5. GENERER FICHIER REAPPROVISIONNEMENT (F-REA) SI SEUIL BAS
001200* FLUX : F-VEU + F-VAS -> DB2 + F-ST -> F-REA
001300*=============================================================
001400 ENVIRONMENT DIVISION.
001500 CONFIGURATION SECTION.
001600 SPECIAL-NAMES.
001700        DECIMAL-POINT IS COMMA.
001800 INPUT-OUTPUT SECTION.
001900 FILE-CONTROL.
002000
002100*** FICHIERS D'ENTREE : VENTESEU ET VENTESAS ***
002200
002300
002400     SELECT F-VEU ASSIGN TO FVEU
002500     ORGANIZATION IS SEQUENTIAL
002600     FILE STATUS IS FS-VEU.
002700
002800     SELECT F-VAS ASSIGN TO FVAS
002900     ORGANIZATION IS SEQUENTIAL
003000     FILE STATUS IS FS-VAS.
003100
003200
003300*** FICHIER D'ENTREE : STOCKS.KSDS ***
003400
003500
003600     SELECT F-ST ASSIGN TO FST
003700     ORGANIZATION IS INDEXED
003800     ACCESS MODE IS DYNAMIC
003900     RECORD KEY IS NUM-PROD-ST
004000     FILE STATUS IS FS-ST.
004100
004200*** FICHIER DE SORTIE : COMMANDES DE REAPPROVISIONNEMENT ***
004300
004400     SELECT F-REA ASSIGN TO FREA
004500     ORGANIZATION IS SEQUENTIAL
004600     FILE STATUS IS FS-REA.
004700
004800
004900 DATA DIVISION.
005000 FILE SECTION.
005100
005200
005300*** DECLARATION FICHIER VENTESEU ***
005400
005500 FD F-VEU
005600     RECORDING MODE IS F.
005700 01 ENR-VEU.
005800    05  ID-VEU             PIC 9(3).
005900    05  DATE-VEU           PIC X(10).
006000    05  NUM-EMP-VEU        PIC 9(2).
006100    05  NUM-CLIENT-VEU     PIC 9(4).
006200    05  NUM-PROD-VEU       PIC X(3).
006300    05  PRICE-VEU          PIC X(5).
006400    05  QTE-ORDERED-VEU    PIC 9(2).
006500    05  FILLER             PIC X(6).
006600
006700*** DECLARATION FICHIER VENTEAS  ***
006800
006900 FD F-VAS
007000     RECORDING MODE IS F.
007100 01 ENR-VAS.
007200    05  ID-VAS             PIC 9(3).
007300    05  DATE-VAS           PIC X(10).
007400    05  NUM-EMP-VAS        PIC 9(2).
007500    05  NUM-CLIENT-VAS     PIC 9(4).
007600    05  NUM-PROD-VAS       PIC X(3).
007700    05  PRICE-VAS          PIC X(5).
007800    05  QTE-ORDERED-VAS    PIC 9(2).
007900    05  FILLER             PIC X(6).
008000
008100*** DECLARATION FICHIER STOCKS  ***
008200
008300 FD F-ST.
008400 01 ENR-ST.
008500    05  NUM-PROD-ST        PIC X(3).
008600    05  SEUIL-PROD-ST      PIC 9(3).
008700    05  QTE-TO-ORD-ST      PIC 9(2).
008800    05  FILLER             PIC X(7).
008900
009000
009100*** DECLARATION FICHIER REAPPRO ***
009200
009300 FD F-REA
009400     RECORDING MODE IS F.
009500 01 ENR-REA.
009600    05  NUM-PROD-REA       PIC X(3).
009700    05  QTE-TO-ORD-REA     PIC 9(2).
009800    05  DATE-ORD-REA       PIC X(10).
009900
010000
010100 WORKING-STORAGE SECTION.
010200
010300*** APPEL SQL ***
010400
010500     EXEC SQL
010600          INCLUDE SQLCA
010700     END-EXEC.
010800
010900*** STRUCTURE D'HOTES POUR LES TABLES ***
011000
011100     EXEC SQL   INCLUDE PRODUCTS     END-EXEC.
011200     EXEC SQL   INCLUDE ORDERS       END-EXEC.
011300     EXEC SQL   INCLUDE ITEMS        END-EXEC.
011400     EXEC SQL   INCLUDE CUSTOMER     END-EXEC.
011500
011600*** CURSEUR POUR PARCOURIR TOUS LES PRODUITS ***
011700
011800     EXEC SQL
011900          DECLARE CPROD CURSOR
012000          FOR
012100          SELECT P_NO, PRICE, STOCK
012200          FROM API7.PRODUCTS
012300     END-EXEC.
012400
012500*** VARIABLES DE CONTROLE COURANT (VENTESEU ET VENTESAS) ***
012600
012700 77 FICHIER-EN-COURS          PIC X VALUE SPACES.
012800    88 LECTURE-VEU            VALUE 'E'.
012900    88 LECTURE-VAS            VALUE 'A'.
013000
013100*** ID DES COMMANDES COURANTE (POUR FUSION) ***
013200
013300 01 WS-ID-VEU                 PIC 9(3).
013400 01 WS-ID-VAS                 PIC 9(3).
013500
013600*** VARIABLES FORMATAGE DES DATES COMMANDES VEU ***
013700
013800 01 WS-DATE-COMM-VEU          PIC X(10) VALUE SPACES.
013900 01 WS-DATE-COMM-FMT-VEU      PIC X(10) VALUE SPACES.
014000
014100*** VARIABLES FORMATAGE DES DATES COMMANDES VAS ***
014200
014300 01 WS-DATE-COMM-VAS          PIC X(10) VALUE SPACES.
014400 01 WS-DATE-COMM-FMT-VAS      PIC X(10) VALUE SPACES.
014500
014600
014700*** TABLEAU CUMULATION DES CLIENTS ***
014800*** (BALANCE TOTALE PAR CLIENT)    ***
014900
015000 01  TAB-CLIENTS.
015100     05  TAB-CLIENT OCCURS 1 TO 999 TIMES
015200         DEPENDING ON NB-CLIENTS
015300         INDEXED BY IDX-CLIENT.
015400         10  CLIENT-NO         PIC 9(4).
015500         10  CLIENT-TOTAL      PIC 9(8)V9(2) VALUE 0.
015600 01  NB-CLIENTS              PIC 9(3) VALUE 0.
015700 01  WS-CLIENT-TROUVE        PIC X VALUE 'N'.
015800
015900
016000*** VARIABLE CONDITIONNEL POUR LES ITEMS  ***
016100*** IGNORANCE DE L'ITEM INVALIDE POUR COMMANDE EN COURS ***
016200
016300 77 WS-ITEM-INSERT-OK           PIC X VALUE 'N'.
016400
016500
016600*** TABLEAU CUMULATION DES VENTES ***
016700*** (QUANTITE TOTALE PAR PRODUIT) ***
016800
016900 01 TAB-VENTES.
017000    05 TAB-VENTE OCCURS 1 TO 999 TIMES
017100       DEPENDING ON NB-PROD-CUMUL
017200       INDEXED BY IDX-VENTE.
017300       10 TAB-PROD            PIC X(3).
017400       10 TAB-QTE-CUMUL       PIC 9(3) VALUE 0.
017500
017600 77 NB-PROD-CUMUL             PIC 999 VALUE 0.
017700 77 TROUVE                    PIC X VALUE 'N'.
017800 77 WS-QTE-TOTALE             PIC 9(3) VALUE 0.
017900
018000*** VARIABLES MISE A JOUR BALANCE ***
018100
018200 77 WS-BALANCE-UPDATE         PIC 9(8)V9(2) VALUE 0.
018300 77 WS-BALANCE-BASE           PIC 9(8)V9(2) VALUE 0.
018400 77 WS-BALANCE-TO-ADD         PIC 9(8)V9(2) VALUE 0.
018500
018600 77 ED-MONTANT                PIC ZZZ.ZZZ.ZZ9,99.
018700
018800 77 WS-CLIENT-NUM             PIC 9(4).
018900
019000
019100*** VARIABLES FILE STATUS ***
019200
019300 77 FS-VEU                 PIC 99.
019400 77 FS-VAS                 PIC 99.
019500 77 FS-ST                  PIC 99.
019600 77 FS-LOG                 PIC 99.
019700 77 FS-REA                 PIC 99.
019800
019900*** VARIABLES FINS DE FICHIER  ***
020000
020100 77 FIN-VEU                PIC X VALUE 'N'.
020200 77 FIN-VAS                PIC X VALUE 'N'.
020300 77 FIN-ST                 PIC X VALUE 'N'.
020400 77 FIN-REA                PIC X VALUE 'N'.
020500
020600
020700*** VARIABLES DE TRAVAIL PRIX ***
020800
020900 77 WS-PU-NUM              PIC 9(3)V9(2).
021000 77 WS-PU-STR              PIC X(5).
021100
021200
021300*** VARIABLES FORMATTAGE DATES  POUR LOGDATA ***
021400
021500 01 WS-DATE                PIC X(8).
021600 01 WS-DATE-FMT            PIC X(10).
021700
021800*** VARIABLES POUR GESTION DES COMMANDES VEU ***
021900
022000 01 WS-COMMANDES-VEU.
022100    05 WS-CURRENT-ORDER-VEU   PIC 9(3) VALUE 0.
022200    05 WS-ORDER-TOTAL-VEU     PIC 9(8)V9(2) VALUE 0.
022300    05 WS-ORDER-INSERTED-VEU  PIC X VALUE 'N'.
022400    05 WS-ORDER-CLIENT-VEU    PIC 9(4) VALUE 0.
022500
022600*** VARIABLES POUR GESTION DES COMMANDES VAS ***
022700
022800 01 WS-COMMANDES-VAS.
022900    05 WS-CURRENT-ORDER-VAS   PIC 9(3) VALUE 0.
023000    05 WS-ORDER-TOTAL-VAS     PIC 9(8)V9(2) VALUE 0.
023100    05 WS-ORDER-INSERTED-VAS  PIC X VALUE 'N'.
023200    05 WS-ORDER-CLIENT-VAS    PIC 9(4) VALUE 0.
023300
023400
023500
023600*** VARIABLE POUR CALCULER LE PRIX ***
023700
023800 77 WS-ITEM-AMOUNT        PIC 9(5)V9(2) VALUE 0.
023900
024000
024100
024200*** VARIABLES REAPPROVISIONNEMENTS CUMULES ***
024300
024400 77 PROD-TRAITE-REA        PIC X(3) VALUE SPACES.
024500 77 QTE-CUMUL-REA          PIC 9(3) VALUE 0.
024600
024700*** VARIABLES TRAITEMENT DES STOCKS ***
024800
024900 01 WS-LAST-PROD           PIC X(3) VALUE SPACES.
025000 01 WS-STOCK-ACTUEL        PIC 9(3) VALUE 0.
025100
025200*** VARIABLES CUMULATION TOTALE DES COMMANDES ***
025300
025400 77 WS-TOTAL-COMMANDES PIC 9(8)V9(2) VALUE 0.
025500
025600
025700*** VARIABLES ANOMALIE SQL ***
025800
025900 77 WS-ANO         PIC 99 VALUE ZERO.
026000 77 WS-MSG-SQL     PIC X(30).
026100
026200 77 ED-SQLCODE     PIC +9(9).
026300
026400
026500
026600*** VARIABLES LOGDATA ***
026700
026800 01  WS-MSG          PIC X(164).
026900 01  WS-PGM          PIC X(8) VALUE 'DB2PART2'.
027000 01  WS-CONTEXT      PIC X(30).
027100 01  WS-CONTEXT-LEN  PIC 99.
027200 01  WS-USER         PIC X(8).
027300
027400
027500*** VARIABLE DEBUG INSERT-ITEMS ***
027600
027700 01 WS-ERREUR        PIC 9 VALUE 0.
027800
027900 PROCEDURE DIVISION.
028000
028100*========================================================
028200* SÉQUENCE PRINCIPALE DU PROGRAMME
028300* 1. INITIALISATION CURSEUR PRODUITS
028400* 2. OUVERTURE FICHIERS
028500* 3. FUSION + TRAITEMENT LIGNE PAR LIGNE
028600* 4. FINALISATION STOCKS/REAPPRO/BALANCES
028700* 5. COMMIT GLOBAL
028800*========================================================
028900
029000            EXEC SQL
029100                 OPEN CPROD
029200            END-EXEC.
029300
029400            MOVE 'OPEN CPROD' TO WS-MSG-SQL
029500            PERFORM TEST-SQLCODE
029600            PERFORM FETCH-CPROD
029700            PERFORM OUVERTURE
029800            PERFORM LECTURE-INITIALE
029900            PERFORM PARCOURT-FICHIERS
030000
030100*           TRAITEMENT FINAL STOCKS POUR LES PRODUITS VENDUS
030200
030300            PERFORM VARYING IDX-VENTE FROM 1 BY 1
030400                    UNTIL IDX-VENTE > NB-PROD-CUMUL
030500
030600                    MOVE TAB-PROD(IDX-VENTE) TO NUM-PROD-ST
030700                    MOVE TAB-QTE-CUMUL(IDX-VENTE) TO WS-QTE-TOTALE
030800                    PERFORM LECTURE-FICHIER-STOCK
030900
031000            END-PERFORM
031100            PERFORM FINALISER-TOUTES-COMMANDES
031200            PERFORM FERMER-FICHIERS
031300
031400            EXEC SQL     COMMIT      END-EXEC
031500
031600            PERFORM TEST-SQLCODE
031700
031800            EXEC SQL    CLOSE CPROD   END-EXEC
031900
032000            GOBACK.
032100
032200******************************************
032300*            FETCH CPROD                 *
032400******************************************
032500
032600 FETCH-CPROD.
032700
032800     EXEC SQL
032900          FETCH CPROD
033000                INTO :PRO-P-NO, :PRO-PRICE, :PRO-STOCK
033100     END-EXEC
033200
033300     PERFORM TEST-SQLCODE
033400     IF SQLCODE = 0
033500        DISPLAY 'FETCH OK'
033600        MOVE 'FETCH CPROD' TO WS-MSG-SQL
033700     ELSE IF SQLCODE = 100
033800        DISPLAY 'FIN DU CURSEUR'
033900        MOVE 'FIN DU CURSEUR' TO WS-MSG-SQL
034000     END-IF
034100     .
034200
034300
034400******************************************
034500*        OUVERTURE DES FICHIERS          *
034600*    CONTROLE DES ERREUR CRITIQUES       *
034700******************************************
034800
034900 OUVERTURE.
035000
035100     OPEN INPUT F-VEU
035200       IF FS-VEU NOT = ZEROES THEN
035300       DISPLAY 'ERREUR OUVERTURE F-VEU : ' FS-VEU
035400       PERFORM FERMER-FICHIERS
035500       END-IF
035600
035700     OPEN INPUT F-VAS
035800       IF FS-VAS NOT = ZEROES THEN
035900       DISPLAY 'ERREUR OUVERTURE F-VAS : ' FS-VAS
036000       PERFORM FERMER-FICHIERS
036100       END-IF
036200
036300     OPEN INPUT F-ST
036400       IF FS-ST NOT = ZEROES THEN
036500       DISPLAY 'ERREUR OUVERTURE F-ST : ' FS-ST
036600       PERFORM FERMER-FICHIERS
036700       END-IF
036800
036900     OPEN OUTPUT F-REA
037000       IF FS-REA NOT = ZEROES THEN
037100       DISPLAY 'ERREUR OUVERTURE F-REA : ' FS-REA
037200       PERFORM FERMER-FICHIERS
037300       END-IF
037400     .
037500
037600
037700******************************************
037800*     LECTURE INITIALE DES FICHIERS      *
037900*   POSITION ID COURANT DES 2 FICHIERS   *
038000******************************************
038100
038200 LECTURE-INITIALE.
038300
038400* LIRE LES FICHERS UNE PREMIERE FOIS POUR PARCOURS
038500* ET COMPARER LES ID
038600
038700     READ F-VEU
038800             AT END
038900                MOVE 'O' TO FIN-VEU
039000             NOT AT END
039100                MOVE 'N' TO FIN-VEU
039200                MOVE ID-VEU TO WS-ID-VEU
039300     END-READ
039400
039500     READ F-VAS
039600             AT END
039700                MOVE 'O' TO FIN-VAS
039800             NOT AT END
039900                MOVE 'N' TO FIN-VAS
040000                MOVE ID-VAS TO WS-ID-VAS
040100     END-READ
040200     .
040300
040400
040500******************************************
040600*    PARCOURS ET FUSION DES FICHIERS     *
040700******************************************
040800
040900 PARCOURT-FICHIERS.
041000
041100* BOUCLE PRINCIPALE : TRAITEMENT JUSQU'A LA FIN DES 2 FICHIERS
041200
041300     PERFORM UNTIL FIN-VEU = 'O' AND FIN-VAS = 'O'
041400
041500      EVALUATE TRUE
041600
041700* CAS 1 : SI VEU < VAS -> TRAITER VEU
041800
041900       WHEN FIN-VEU = 'N' AND FIN-VAS = 'N' AND
042000             WS-ID-VEU < WS-ID-VAS
042100       PERFORM TRAITER-LIGNE-VEU-COURANTE
042200       PERFORM LECTURE-SUIVANTE-VEU
042300
042400* CAS 2 : SI VAS < VEU -> TRAITER VAS
042500
042600       WHEN FIN-VEU = 'N' AND FIN-VAS = 'N' AND
042700            WS-ID-VAS < WS-ID-VEU
042800       PERFORM TRAITER-LIGNE-VAS-COURANTE
042900       PERFORM LECTURE-SUIVANTE-VAS
043000
043100* CAS 3 : ID IDENTIQUES -> TRAITER LES 2
043200
043300       WHEN FIN-VEU = 'N' AND FIN-VAS = 'N' AND
043400            WS-ID-VEU = WS-ID-VAS
043500       PERFORM TRAITER-LIGNE-VEU-COURANTE
043600       PERFORM LECTURE-SUIVANTE-VEU
043700       PERFORM TRAITER-LIGNE-VAS-COURANTE
043800       PERFORM LECTURE-SUIVANTE-VAS
043900
044000* CAS 4 : FIN VAS -> FINIR VEU
044100
044200       WHEN FIN-VEU = 'N' AND FIN-VAS = 'O'
044300       PERFORM TRAITER-LIGNE-VEU-COURANTE
044400       PERFORM LECTURE-SUIVANTE-VEU
044500
044600* CAS 5 : FIN VEU -> FINIR VAS
044700
044800       WHEN FIN-VAS = 'N' AND FIN-VEU = 'O'
044900       PERFORM TRAITER-LIGNE-VAS-COURANTE
045000       PERFORM LECTURE-SUIVANTE-VAS
045100
045200* SECURITE
045300
045400       WHEN OTHER
045500       DISPLAY 'CAS NON PREVU - ARRET'
045600       MOVE 'O' TO FIN-VEU
045700       MOVE 'O' TO FIN-VAS
045800
045900      END-EVALUATE
046000     END-PERFORM
046100     .
046200
046300***************************************************
046400*   LECTURE SUIVANTE VEU (GESTION FIN DE FICHIER) *
046500***************************************************
046600
046700* LECTURE DES LIGNES SUIVANTES
046800
046900 LECTURE-SUIVANTE-VEU.
047000
047100     READ F-VEU
047200         AT END
047300             MOVE 'O' TO FIN-VEU
047400         NOT AT END
047500             MOVE ID-VEU TO WS-ID-VEU
047600     END-READ
047700     .
047800
047900
048000******************************************
048100*   LECTURE SUIVANTE VAS                *
048200******************************************
048300
048400* LECTURE DES LIGNES SUIVANTES
048500
048600 LECTURE-SUIVANTE-VAS.
048700
048800     READ F-VAS
048900         AT END
049000             MOVE 'O' TO FIN-VAS
049100         NOT AT END
049200             MOVE ID-VAS TO WS-ID-VAS
049300     END-READ
049400     .
049500
049600******************************************
049700*   TRAITER LIGNE VEU COURANTE          *
049800******************************************
049900
050000* PREPARATION DES VARIABLES DE TRAVAIL PUIS ORDRE D'EXECUTION
050100* DES PROGRAMMES
050200
050300 TRAITER-LIGNE-VEU-COURANTE.
050400     DISPLAY '------------------------------------------'
050500     DISPLAY 'LECTURE VENTES EU : ' ENR-VEU
050600     MOVE NUM-PROD-VEU TO NUM-PROD-ST
050700     MOVE DATE-VEU TO WS-DATE-COMM-VEU
050800     PERFORM FORMAT-DATE-VEU
050900     SET LECTURE-VEU TO TRUE
051000     PERFORM TRAITER-LIGNE-VEU
051100     .
051200
051300*****************************************
051400*   TRAITER LIGNE VAS COURANTE          *
051500******************************************
051600
051700* PREPARATION DES VARIABLES DE TRAVAIL PUIS ORDRE D'EXECUTION
051800* DES PROGRAMMES
051900
052000 TRAITER-LIGNE-VAS-COURANTE.
052100     DISPLAY '------------------------------------------'
052200     DISPLAY 'LECTURE VENTES AS : ' ENR-VAS
052300     MOVE NUM-PROD-VAS TO NUM-PROD-ST
052400     MOVE DATE-VAS TO WS-DATE-COMM-VAS
052500     PERFORM FORMAT-DATE-VAS
052600     SET LECTURE-VAS TO TRUE
052700     PERFORM TRAITER-LIGNE-VAS
052800     .
052900
053000
053100
053200*******************************************
053300*   LECTURE FICHIER STOCK (CLE = PRODUIT) *
053400*******************************************
053500
053600
053700 LECTURE-FICHIER-STOCK.
053800
053900     READ F-ST KEY IS NUM-PROD-ST
054000          INVALID KEY
054100             DISPLAY 'PRODUIT INEXISTANT : ' NUM-PROD-ST
054200          NOT INVALID KEY
054300             DISPLAY '---------------------------------'
054400             DISPLAY 'PRODUIT EXISTE : ' NUM-PROD-ST
054500            PERFORM CALCUL-STOCKS-CUMULES
054600     END-READ
054700     .
054800
054900******************************************
055000*   FORMAT DATES COMMANDES VEU           *
055100******************************************
055200
055300* FORMATAGE DES DATES POUR AJOUTS FUTURS EN BDD
055400* REORGANISATION : AAAA-MM-JJ
055500
055600 FORMAT-DATE-VEU.
055700
055800     DISPLAY 'LIGNE DATE COMMANDE VEU : ' WS-DATE-COMM-VEU
055900     MOVE WS-DATE-COMM-VEU(7:4) TO WS-DATE-COMM-FMT-VEU(1:4)
056000     MOVE '-'                   TO WS-DATE-COMM-FMT-VEU(5:1)
056100     MOVE WS-DATE-COMM-VEU(4:2) TO WS-DATE-COMM-FMT-VEU(6:2)
056200     MOVE '-'                   TO WS-DATE-COMM-FMT-VEU(8:1)
056300     MOVE WS-DATE-COMM-VEU(1:2) TO WS-DATE-COMM-FMT-VEU(9:2)
056400
056500     DISPLAY 'DATE REFORMATEE POUR BDD : ' WS-DATE-COMM-FMT-VEU
056600     MOVE WS-DATE-COMM-FMT-VEU TO DATE-VEU
056700     .
056800
056900
057000******************************************
057100*   FORMAT DATES COMMANDES VAS           *
057200******************************************
057300
057400* FORMATAGE DES DATES POUR AJOUTS FUTURS EN BDD
057500* REORGANISATION : AAAA-MM-JJ
057600
057700 FORMAT-DATE-VAS.
057800
057900     DISPLAY 'LIGNE DATE COMMANDE VEU : ' WS-DATE-COMM-VAS
058000     MOVE WS-DATE-COMM-VAS(7:4) TO WS-DATE-COMM-FMT-VAS(1:4)
058100     MOVE '-'                   TO WS-DATE-COMM-FMT-VAS(5:1)
058200     MOVE WS-DATE-COMM-VAS(4:2) TO WS-DATE-COMM-FMT-VAS(6:2)
058300     MOVE '-'                   TO WS-DATE-COMM-FMT-VAS(8:1)
058400     MOVE WS-DATE-COMM-VAS(1:2) TO WS-DATE-COMM-FMT-VAS(9:2)
058500
058600     DISPLAY 'DATE REFORMATEE POUR BDD : ' WS-DATE-COMM-FMT-VAS
058700     MOVE WS-DATE-COMM-FMT-VAS TO DATE-VAS
058800     .
058900
059000
059100******************************************
059200*   VERIFICATION DES LIGNES SANS PRIX    *
059300******************************************
059400
059500* RECHERCHE DU PRIX SI MANQUANT DANS FICHIER VENTESEU
059600* UTILISATION DU CURSEUR CPROD SUR TABLE PRODUCTS
059700
059800 VERIFICATION-VEU-SANS-PRIX.
059900
060000
060100     IF PRICE-VEU = SPACES
060200        DISPLAY 'PRIX MANQUANT POUR :' NUM-PROD-VEU
060300            EXEC SQL    CLOSE CPROD    END-EXEC
060400            EXEC SQL    OPEN CPROD     END-EXEC
060500
060600        PERFORM FETCH-CPROD
060700        PERFORM TEST-SQLCODE
060800
060900* PARCOURIR JUSQU'AU PRODUIT OU FIN CURSEUR
061000
061100        PERFORM UNTIL PRO-P-NO = NUM-PROD-VEU
061200                OR SQLCODE = 100
061300
061400                PERFORM FETCH-CPROD
061500                PERFORM TEST-SQLCODE
061600
061700        END-PERFORM
061800
061900        IF SQLCODE = 0
062000           DISPLAY 'PRIX TROUVE EN BASE :' PRO-P-NO
062100           DISPLAY 'PRIX TROUVE : ' PRO-PRICE
062200
062300        ELSE
062400           DISPLAY 'PRODUIT INEXISTANT EN BASE : ' NUM-PROD-VEU
062500
062600*       LOG ERREUR SI PRODUIT MANQUANT DANS LA BDD
062700
062800           MOVE SPACES TO WS-CONTEXT
062900           MOVE 1 TO WS-CONTEXT-LEN
063000           STRING 'VERIFICATION VEU SANS PRIX' DELIMITED BY SIZE
063100                  INTO WS-CONTEXT
063200                  WITH POINTER WS-CONTEXT-LEN
063300           END-STRING
063400           SUBTRACT 1 FROM WS-CONTEXT-LEN
063500
063600
063700           STRING
063800            'ERREUR '                     DELIMITED BY SIZE
063900            WS-CONTEXT(1:WS-CONTEXT-LEN)  DELIMITED BY SIZE
064000             ' NUM-PROD-VEU : '           DELIMITED BY SIZE
064100             NUM-PROD-VEU                 DELIMITED BY SIZE
064200             INTO WS-MSG
064300             PERFORM LOG
064400        END-IF
064500     END-IF
064600      .
064700
064800
064900 VERIFICATION-VAS-SANS-PRIX.
065000
065100* IDENTIQUE A VERIFICATION-VEU-SANS-PRIX
065200
065300
065400     IF PRICE-VAS = SPACES
065500        DISPLAY 'PRIX MANQUANT POUR :' NUM-PROD-VAS
065600            EXEC SQL    CLOSE CPROD    END-EXEC
065700            EXEC SQL    OPEN CPROD     END-EXEC
065800        PERFORM FETCH-CPROD
065900        PERFORM TEST-SQLCODE
066000
066100        PERFORM UNTIL PRO-P-NO = NUM-PROD-VAS
066200                OR SQLCODE = 100
066300
066400                PERFORM FETCH-CPROD
066500                PERFORM TEST-SQLCODE
066600
066700        END-PERFORM
066800
066900        IF SQLCODE = 0
067000           DISPLAY 'PRIX TROUVE EN BASE :' PRO-P-NO
067100           DISPLAY 'PRIX TROUVE : ' PRO-PRICE
067200
067300
067400        ELSE
067500           DISPLAY 'PRODUIT INEXISTANT EN BASE : ' NUM-PROD-VAS
067600
067700           MOVE SPACES TO WS-MSG
067800           MOVE SPACES TO WS-CONTEXT
067900           MOVE 1 TO WS-CONTEXT-LEN
068000           STRING 'VERIFICATION VAS SANS PRIX' DELIMITED BY SIZE
068100                  INTO WS-CONTEXT
068200                  WITH POINTER WS-CONTEXT-LEN
068300           END-STRING
068400           SUBTRACT 1 FROM WS-CONTEXT-LEN
068500
068600           STRING
068700            'ERREUR '                    DELIMITED BY SIZE
068800            WS-CONTEXT(1:WS-CONTEXT-LEN) DELIMITED BY SIZE
068900            'NUM-PRO-VAS :'              DELIMITED BY SIZE
069000             NUM-PROD-VAS                DELIMITED BY SIZE
069100             INTO WS-MSG
069200             PERFORM LOG
069300        END-IF
069400     END-IF
069500      .
069600
069700*=================================================
069800* TRAITEMENT UNE LIGNE VENTE EUROPÉENNE
069900* 1. NOUVELLE COMMANDE ? ± INSERT ORDERS
070000* 2. PRIX MANQUANT ? ± RECHERCHE PRODUCTS
070100* 3. INSERT ITEMS + CUMULS
070200*=================================================
070300
070400
070500**************************************************
070600*      TRAITER LIGNE VEU                         *
070700**************************************************
070800
070900
071000 TRAITER-LIGNE-VEU.
071100
071200
071300* VERIFIER SI NOUVELLE COMMANDE VEU (CHANGEMENT ID)
071400
071500     MOVE 'N' TO WS-ITEM-INSERT-OK
071600     IF ID-VEU NOT = WS-CURRENT-ORDER-VEU
071700
071800
071900* REINITIALISER POUR NOUVELLE COMMANDE
072000
072100        MOVE ID-VEU TO WS-CURRENT-ORDER-VEU
072200        MOVE 0 TO WS-ORDER-TOTAL-VEU
072300        MOVE 'N' TO WS-ORDER-INSERTED-VEU
072400
072500
072600* INSERER LA COMMANDE
072700
072800        PERFORM INSERER-COMMANDE-VEU
072900     END-IF
073000
073100     MOVE NUM-CLIENT-VEU TO WS-CLIENT-NUM
073200
073300* VERIFIER ET RECUPERER PRIX SI MANQUANT
073400
073500     PERFORM VERIFICATION-VEU-SANS-PRIX
073600
073700* SI TOUT EST BON AU NIVEAU DU SQL
073800* INSERER LES ITEMS PUIS CUMULER LES VENTES
073900
074000     IF SQLCODE = 0
074100
074200        PERFORM INSERER-ITEM-VEU
074300        PERFORM CUMULER-VENTES
074400
074500        IF WS-ITEM-INSERT-OK = 'O'
074600           PERFORM CUMULER-MONTANT-CLIENT
074700        END-IF
074800
074900     ELSE
075000
075100*    LOG ERREUR PRODUIT INEXSITANT
075200
075300        DISPLAY 'PRODUIT NON AJOUTE (INEXISTANT) : '
075400                NUM-PROD-VEU
075500           MOVE SPACES TO WS-MSG
075600           MOVE SPACES TO WS-CONTEXT
075700           MOVE 1 TO WS-CONTEXT-LEN
075800           STRING 'TRAITER LIGNE VEU' DELIMITED BY SIZE
075900                  INTO WS-CONTEXT
076000                  WITH POINTER WS-CONTEXT-LEN
076100           END-STRING
076200           SUBTRACT 1 FROM WS-CONTEXT-LEN
076300           STRING
076400            'ERREUR :'                     DELIMITED BY SIZE
076500            WS-CONTEXT(1:WS-CONTEXT-LEN)   DELIMITED BY SIZE
076600            'NUM-PROD-VEU :'               DELIMITED BY SIZE
076700             NUM-PROD-VEU                  DELIMITED BY SIZE
076800            'NON AJOUTE DANS ITEMS'        DELIMITED BY SIZE
076900             INTO WS-MSG
077000             PERFORM LOG
077100     END-IF
077200
077300     .
077400
077500
077600**********************************************
077700*      TRAITEMENT LIGNE VENTESAS             *
077800**********************************************
077900
078000 TRAITER-LIGNE-VAS.
078100
078200* CODE SYMETRIQUE A TRAITER-LIGNE-VAS
078300* VERIFIER SI NOUVELLE COMMANDE
078400
078500     MOVE 'N' TO WS-ITEM-INSERT-OK
078600     IF ID-VAS NOT = WS-CURRENT-ORDER-VAS
078700
078800
078900* REINITIALISER POUR NOUVELLE COMMANDE
079000
079100        MOVE ID-VAS TO WS-CURRENT-ORDER-VAS
079200        MOVE 0 TO WS-ORDER-TOTAL-VAS
079300        MOVE 'N' TO WS-ORDER-INSERTED-VAS
079400
079500* INSERER LA COMMANDE
079600
079700        PERFORM INSERER-COMMANDE-VAS
079800     END-IF
079900
080000     MOVE NUM-CLIENT-VAS TO WS-CLIENT-NUM
080100
080200* VERIFIER ET RECUPERER PRIX SI MANQUANT
080300
080400     PERFORM VERIFICATION-VAS-SANS-PRIX
080500
080600* SI TOUT EST BON AU NIVEAU DU SQL
080700* INSERER LES ITEMS PUIS CUMULER LES VENTES
080800
080900     IF SQLCODE = 0
081000
081100        PERFORM INSERER-ITEM-VAS
081200        PERFORM CUMULER-VENTES
081300
081400        IF WS-ITEM-INSERT-OK = 'O'
081500           PERFORM CUMULER-MONTANT-CLIENT
081600        END-IF
081700
081800     ELSE
081900
082000        DISPLAY 'PRODUIT NON AJOUTE (INEXISTANT) : '
082100                NUM-PROD-VAS
082200
082300           MOVE SPACES TO WS-MSG
082400           MOVE SPACES TO WS-CONTEXT
082500           MOVE 1 TO WS-CONTEXT-LEN
082600           STRING 'TRAITER LIGNE VAS' DELIMITED BY SIZE
082700                  INTO WS-CONTEXT
082800                  WITH POINTER WS-CONTEXT-LEN
082900           END-STRING
083000           SUBTRACT 1 FROM WS-CONTEXT-LEN
083100           STRING
083200            'ERREUR :'                   DELIMITED BY SIZE
083300            WS-CONTEXT(1:WS-CONTEXT-LEN) DELIMITED BY SIZE
083400            'NUM-PROD-VAS :'             DELIMITED BY SIZE
083500             NUM-PROD-VAS                DELIMITED BY SIZE
083600             'NON AJOUTE DANS ITEMS'     DELIMITED BY SIZE
083700             INTO WS-MSG
083800             PERFORM LOG
083900     END-IF
084000     .
084100
084200
084300******************************************
084400*       INSERTION COMMANDE VEU           *
084500******************************************
084600
084700 INSERER-COMMANDE-VEU.
084800
084900
085000* PREPARER LES VARIABLES POUR INSERT
085100
085200     MOVE ID-VEU TO ORD-O-NO
085300     MOVE NUM-EMP-VEU TO ORD-S-NO
085400     MOVE NUM-CLIENT-VEU TO ORD-C-NO
085500     MOVE DATE-VEU TO ORD-O-DATE
085600     MOVE NUM-CLIENT-VEU TO WS-ORDER-CLIENT-VEU
085700
085800* INSERER DANS ORDERS
085900
086000     EXEC SQL
086100          INSERT INTO API7.ORDERS
086200                 (O_NO,
086300                  S_NO,
086400                  C_NO,
086500                  O_DATE
086600                  )
086700          VALUES (:ORD-O-NO,
086800                  :ORD-S-NO,
086900                  :ORD-C-NO,
087000                  :ORD-O-DATE
087100                  )
087200     END-EXEC
087300
087400     MOVE SQLCODE TO ED-SQLCODE
087500     DISPLAY 'CODE SQL : ' ED-SQLCODE
087600     EVALUATE TRUE
087700
087800* SI TOUT EST BON, AJOUTER LA COMMANDE DANS LA TABLES ORDERS
087900
088000       WHEN SQLCODE = ZERO
088100            DISPLAY 'COMMANDE VEU NUMERO : ' ID-VEU 'AJOUTE'
088200            DISPLAY '--- LECTURE COMMANDE AJOUTEE ---'
088300            DISPLAY 'CODE COMMANDE : '  ORD-O-NO
088400            DISPLAY 'CODE EMPLOYE : ' ORD-S-NO
088500            DISPLAY 'CODE CLIENT : ' ORD-C-NO
088600            DISPLAY 'DATE COMMANDE : ' ORD-O-DATE
088700            MOVE 'O' TO WS-ORDER-INSERTED-VEU
088800            MOVE ID-VEU TO WS-CURRENT-ORDER-VAS
088900
089000*      SI DOUBLON, IGNORER (COMMANDE EXISTE DEJA)
089100
089200
089300       WHEN SQLCODE = -803
089400            DISPLAY ID-VEU 'EXISTE DEJA ! (IGNORE)'
089500            MOVE SPACES TO WS-MSG
089600            MOVE SPACES TO WS-CONTEXT
089700            MOVE 1 TO WS-CONTEXT-LEN
089800            STRING 'INSERER COMMANDE VEU' DELIMITED BY SIZE
089900                   INTO WS-CONTEXT
090000                   WITH POINTER WS-CONTEXT-LEN
090100            END-STRING
090200            SUBTRACT 1 FROM WS-CONTEXT-LEN
090300
090400            STRING
090500            'ERREUR '    DELIMITED BY SIZE
090600            WS-CONTEXT(1:WS-CONTEXT-LEN) DELIMITED BY SIZE
090700            'ID-VEU :'                   DELIMITED BY SIZE
090800            ID-VEU                       DELIMITED BY SIZE
090900            'DOUBLON'                    DELIMITED BY SIZE
091000            INTO WS-MSG
091100            PERFORM LOG
091200
091300
091400* AUTRE CODE SQL POSITIF : DECLANCHER LE WARNING
091500
091600       WHEN SQLCODE > ZERO
091700            DISPLAY 'WARNING !' ED-SQLCODE
091800
091900            MOVE SPACES TO WS-MSG
092000            MOVE SPACES TO WS-CONTEXT
092100            MOVE 1 TO WS-CONTEXT-LEN
092200            STRING 'INSERER COMMANDE VEU' DELIMITED BY SIZE
092300                   INTO WS-CONTEXT
092400                   WITH POINTER WS-CONTEXT-LEN
092500            END-STRING
092600            SUBTRACT 1 FROM WS-CONTEXT-LEN
092700
092800            STRING
092900            'ERREUR : '                  DELIMITED BY SIZE
093000            WS-CONTEXT(1:WS-CONTEXT-LEN) DELIMITED BY SIZE
093100            'WARNING'                    DELIMITED BY SIZE
093200            'POUR L ID : '               DELIMITED BY SIZE
093300            ID-VEU                       DELIMITED BY SIZE
093400            INTO WS-MSG
093500            PERFORM LOG
093600
093700*      SECURISATION ET ANTICIPATION D'AUTRES CAS
093800
093900       WHEN OTHER
094000            DISPLAY 'ANO-SQLCODE : ' ED-SQLCODE
094100
094200            EXEC SQL         ROLLBACK         END-EXEC
094300
094400            PERFORM TEST-SQLCODE
094500
094600            MOVE SPACES TO WS-MSG
094700            MOVE SPACES TO WS-CONTEXT
094800            MOVE 1 TO WS-CONTEXT-LEN
094900            STRING 'INSERER COMMANDE VEU' DELIMITED BY SIZE
095000                   INTO WS-CONTEXT
095100                   WITH POINTER WS-CONTEXT-LEN
095200            END-STRING
095300            SUBTRACT 1 FROM WS-CONTEXT-LEN
095400
095500            STRING
095600            'ANOMALIE SQLCODE : '          DELIMITED BY SIZE
095700            WS-CONTEXT(1:WS-CONTEXT-LEN)   DELIMITED BY SIZE
095800            'POUR L ID : '                 DELIMITED BY SIZE
095900            ID-VEU                         DELIMITED BY SIZE
096000            INTO WS-MSG
096100            PERFORM LOG
096200     END-EVALUATE
096300         .
096400
096500******************************************
096600*       INSERTION COMMANDE VAS           *
096700******************************************
096800
096900 INSERER-COMMANDE-VAS.
097000
097100* CODE SYMETRIQUE A INSERTION-COMMANDE-VEU
097200* PREPARER LES VARIABLES POUR INSERT
097300
097400     MOVE ID-VAS TO ORD-O-NO
097500     MOVE NUM-EMP-VAS TO ORD-S-NO
097600     MOVE NUM-CLIENT-VAS TO ORD-C-NO
097700     MOVE DATE-VAS TO ORD-O-DATE
097800     MOVE NUM-CLIENT-VAS TO WS-ORDER-CLIENT-VAS
097900
098000* INSERER DANS ORDERS
098100
098200     EXEC SQL
098300          INSERT INTO API7.ORDERS
098400                 (O_NO,
098500                  S_NO,
098600                  C_NO,
098700                  O_DATE
098800                  )
098900          VALUES (:ORD-O-NO,
099000                  :ORD-S-NO,
099100                  :ORD-C-NO,
099200                  :ORD-O-DATE
099300                  )
099400     END-EXEC
099500
099600     MOVE SQLCODE TO ED-SQLCODE
099700     DISPLAY 'CODE SQL : ' ED-SQLCODE
099800     EVALUATE TRUE
099900       WHEN SQLCODE = ZERO
100000            DISPLAY 'COMMANDE VAS NUMERO : ' ID-VAS 'AJOUTE'
100100            DISPLAY '--- LECTURE COMMANDE AJOUTEE ---'
100200            DISPLAY 'CODE COMMANDE : ' ORD-O-NO
100300            DISPLAY 'CODE EMPLOYE : ' ORD-S-NO
100400            DISPLAY 'CODE CLIENT : ' ORD-C-NO
100500            DISPLAY 'DATE COMMANDE : ' ORD-O-DATE
100600            MOVE 'O' TO WS-ORDER-INSERTED-VAS
100700            MOVE ID-VAS TO WS-CURRENT-ORDER-VEU
100800
100900       WHEN SQLCODE = -803
101000            DISPLAY ID-VAS 'EXISTE DEJA ! IGNORE'
101100            MOVE SPACES TO WS-MSG
101200            MOVE SPACES TO WS-CONTEXT
101300            MOVE 1 TO WS-CONTEXT-LEN
101400            STRING 'INSERER COMMANDE VAS' DELIMITED BY SIZE
101500                   INTO WS-CONTEXT
101600                   WITH POINTER WS-CONTEXT-LEN
101700            END-STRING
101800            SUBTRACT 1 FROM WS-CONTEXT-LEN
101900
102000            STRING
102100            'ERREUR'                     DELIMITED BY SIZE
102200            WS-CONTEXT(1:WS-CONTEXT-LEN) DELIMITED BY SIZE
102300            'DOUBLON POUR L ID'          DELIMITED BY SIZE
102400            ID-VAS                       DELIMITED BY SIZE
102500            'IGNORE'                     DELIMITED BY SIZE
102600            INTO WS-MSG
102700            PERFORM LOG
102800
102900       WHEN SQLCODE > ZERO
103000            DISPLAY 'WARNING !' ED-SQLCODE
103100            MOVE SPACES TO WS-MSG
103200            MOVE SPACES TO WS-CONTEXT
103300            MOVE 1 TO WS-CONTEXT-LEN
103400            STRING 'INSERER COMMANDE VAS' DELIMITED BY SIZE
103500                   INTO WS-CONTEXT
103600                   WITH POINTER WS-CONTEXT-LEN
103700            END-STRING
103800            SUBTRACT 1 FROM WS-CONTEXT-LEN
103900            STRING
104000            'ERREUR : '                  DELIMITED BY SIZE
104100            WS-CONTEXT(1:WS-CONTEXT-LEN) DELIMITED BY SIZE
104200            'POUR L ID : '               DELIMITED BY SIZE
104300            ID-VAS                       DELIMITED BY SIZE
104400            'WARNING'                    DELIMITED BY SIZE
104500            INTO WS-MSG
104600            PERFORM LOG
104700
104800       WHEN OTHER
104900            DISPLAY 'ANO-SQLCODE : ' ED-SQLCODE
105000
105100            EXEC SQL         ROLLBACK         END-EXEC
105200
105300            PERFORM TEST-SQLCODE
105400
105500            MOVE SPACES TO WS-MSG
105600            MOVE SPACES TO WS-CONTEXT
105700            MOVE 1 TO WS-CONTEXT-LEN
105800            STRING 'INSERER COMMANDE VAS' DELIMITED BY SIZE
105900                   INTO WS-CONTEXT
106000                   WITH POINTER WS-CONTEXT-LEN
106100            END-STRING
106200            SUBTRACT 1 FROM WS-CONTEXT-LEN
106300
106400            STRING
106500            'ERREUR '                    DELIMITED BY SIZE
106600            WS-CONTEXT(1:WS-CONTEXT-LEN) DELIMITED BY SIZE
106700            'ANO SQLCODE '                DELIMITED BY SIZE
106800            'POUR L ID : '               DELIMITED BY SIZE
106900            ID-VAS                       DELIMITED BY SIZE
107000            INTO WS-MSG
107100            PERFORM LOG
107200     END-EVALUATE
107300         .
107400
107500
107600******************************************
107700*   INSERTION ITEM VEU                   *
107800******************************************
107900
108000 INSERER-ITEM-VEU.
108100
108200     MOVE ZERO TO SQLCODE
108300
108400
108500* PREPARER VARIABLES ITEMS
108600
108700     MOVE ID-VEU TO ITE-O-NO
108800     MOVE NUM-PROD-VEU TO ITE-P-NO
108900     MOVE QTE-ORDERED-VEU TO ITE-QUANTITY
109000
109100
109200* RECUPERER LE PRIX (DU FICHIER OU DE LA BASE)
109300* PUIS CONVERSION EN NUMERIQUE
109400
109500     IF PRICE-VEU NOT = SPACES
109600        DISPLAY 'PRIX FICHIER TROUVE : ' PRICE-VEU
109700        MOVE PRICE-VEU TO WS-PU-STR
109800        COMPUTE WS-PU-NUM = FUNCTION NUMVAL(WS-PU-STR) / 100
109900        MOVE WS-PU-NUM TO ITE-PRICE
110000        DISPLAY 'PRIX FICHIER : ' PRICE-VEU
110100        DISPLAY 'PRIX CONVERTI : ' ITE-PRICE
110200     ELSE
110300
110400*    SI PRIX INEXISTANT DANS LES FICHIERS VENTES
110500*    RECHERCHE CURSEUR PRODUCTS
110600
110700        DISPLAY 'PRIX MANQUANT -RECHERCHE EN BASE POUR : '
110800                 NUM-PROD-VEU
110900
111000     EXEC SQL            CLOSE CPROD             END-EXEC
111100     EXEC SQL            OPEN CPROD              END-EXEC
111200
111300        PERFORM FETCH-CPROD
111400        PERFORM TEST-SQLCODE
111500
111600        PERFORM UNTIL PRO-P-NO = NUM-PROD-VEU
111700                OR SQLCODE = 100
111800
111900                PERFORM FETCH-CPROD
112000                PERFORM TEST-SQLCODE
112100        END-PERFORM
112200
112300         IF SQLCODE = 0
112400            DISPLAY 'PRIX TROUVE EN BASE : ' PRO-PRICE
112500            DISPLAY 'PRIX PRO-PRICE AFFICHAGE :' PRO-PRICE
112600            DISPLAY 'PRIX PRO-PRICE VALEUR : [' PRO-PRICE ']'
112700            MOVE PRO-PRICE TO ITE-PRICE
112800         ELSE
112900
113000*        SI PRIX INEXISTANT EN BASE (PRODUIT INEXISTANT)
113100*        JOURNALISATION
113200
113300            DISPLAY 'PAS DE PRIX DISPONIBLE POUR : ' NUM-PROD-VEU
113400            DISPLAY '--- PARAGRAPHE INSERTION ITEMS ---'
113500
113600            MOVE SPACES TO WS-MSG
113700            MOVE SPACES TO WS-CONTEXT
113800            MOVE 1 TO WS-CONTEXT-LEN
113900            STRING 'INSERER ITEM VEU' DELIMITED BY SIZE
114000                   INTO WS-CONTEXT
114100                   WITH POINTER WS-CONTEXT-LEN
114200            END-STRING
114300            SUBTRACT 1 FROM WS-CONTEXT-LEN
114400
114500            STRING
114600             'ERREUR ' DELIMITED BY SIZE
114700             WS-CONTEXT(1:WS-CONTEXT-LEN) DELIMITED BY SIZE
114800             'PRIX NON TROUVE EN BDD' DELIMITED BY SIZE
114900             'POUR LE PRODUIT : '         DELIMITED BY SIZE
115000              NUM-PROD-VEU DELIMITED BY SIZE
115100              INTO WS-MSG
115200              PERFORM LOG
115300         END-IF
115400     END-IF
115500
115600
115700* CALCULER MONTANT LIGNE
115800
115900     COMPUTE WS-ITEM-AMOUNT = ITE-PRICE * ITE-QUANTITY
116000     DISPLAY 'CALCUL MONTANT : ' ITE-PRICE '*' ITE-QUANTITY
116100                             '=' WS-ITEM-AMOUNT
116200
116300* VERIFICATION EXISTANCE PRODUIT AVANT INSERT (DEBUG)
116400
116500     EXEC SQL
116600          SELECT P_NO
116700          INTO :PRO-P-NO
116800          FROM API7.PRODUCTS
116900          WHERE P_NO = :ITE-P-NO
117000     END-EXEC
117100
117200     IF SQLCODE = 100
117300        DISPLAY 'ERREUR: PRODUIT INEXISTANT' ITE-P-NO
117400        MOVE 1 TO WS-ERREUR
117500     END-IF
117600
117700     IF SQLCODE NOT = 0 AND SQLCODE NOT = 100
117800        DISPLAY 'ERREUR SQL ORDERS : ' SQLCODE
117900        MOVE 1 TO WS-ERREUR
118000     END-IF
118100
118200*    SI TOUT EST BON, AJOUT DANS ITEMS
118300*    SINON : JOURNALISATION
118400
118500     IF WS-ERREUR = 0
118600
118700        EXEC SQL
118800            INSERT INTO API7.ITEMS
118900                   (O_NO,
119000                    P_NO,
119100                    QUANTITY,
119200                    PRICE
119300                    )
119400            VALUES (:ITE-O-NO,
119500                    :ITE-P-NO,
119600                    :ITE-QUANTITY,
119700                    :ITE-PRICE
119800                    )
119900        END-EXEC
120000
120100       IF SQLCODE NOT = 0
120200          DISPLAY 'ERREUR INSERT ITEM:' SQLCODE
120300       END-IF
120400     END-IF
120500
120600
120700     MOVE 'INSERT ITEMS VEU' TO WS-MSG-SQL
120800     MOVE SQLCODE TO ED-SQLCODE
120900     PERFORM TEST-SQLCODE
121000
121100     EVALUATE TRUE
121200
121300        WHEN SQLCODE = ZERO
121400             ADD WS-ITEM-AMOUNT TO WS-ORDER-TOTAL-VEU
121500             MOVE 'O' TO WS-ITEM-INSERT-OK
121600             DISPLAY ' --- LECTURE ITEMS AJOUTES --- '
121700             DISPLAY ' COMMANDE VEU INSERE : ' ITE-O-NO
121800             DISPLAY ' ID DU PRODUIT :' ITE-P-NO
121900             DISPLAY ' QTE :' ITE-QUANTITY
122000             DISPLAY ' PRIX :' ITE-PRICE
122100
122200
122300        WHEN SQLCODE = -803
122400             DISPLAY '  ITEM VEU DEJA EXISTANT : ' NUM-PROD-VEU
122500             MOVE SPACES TO WS-MSG
122600             MOVE SPACES TO WS-CONTEXT
122700             MOVE 1 TO WS-CONTEXT-LEN
122800             STRING 'INSERER ITEM VEU' DELIMITED BY SIZE
122900                    INTO WS-CONTEXT
123000                    WITH POINTER WS-CONTEXT-LEN
123100             END-STRING
123200             SUBTRACT 1 FROM WS-CONTEXT-LEN
123300
123400             STRING
123500               'ERREUR '                    DELIMITED BY SIZE
123600               WS-CONTEXT(1:WS-CONTEXT-LEN) DELIMITED BY SIZE
123700               'DOUBLON POUR ID : '         DELIMITED BY SIZE
123800                ID-VEU                      DELIMITED BY SIZE
123900                'AJOUT ITEM VEU ANNULE'     DELIMITED BY SIZE
124000               INTO WS-MSG
124100             END-STRING
124200             PERFORM LOG
124300
124400        WHEN OTHER
124500             DISPLAY '  ERREUR INSERT ITEM VEU : ' NUM-PROD-VEU
124600             DISPLAY '  SQLCODE : ' ED-SQLCODE
124700
124800             MOVE SPACES TO WS-MSG
124900             MOVE SPACES TO WS-CONTEXT
125000             MOVE 1 TO WS-CONTEXT-LEN
125100             STRING 'INSERER ITEM VEU' DELIMITED BY SIZE
125200                    INTO WS-CONTEXT
125300                    WITH POINTER WS-CONTEXT-LEN
125400             END-STRING
125500             SUBTRACT 1 FROM WS-CONTEXT-LEN
125600
125700             STRING
125800              'ERREUR INSERT ITEM VEU :'   DELIMITED BY SIZE
125900              WS-CONTEXT(1:WS-CONTEXT-LEN) DELIMITED BY SIZE
126000              'ANOMALIE SQL'               DELIMITED BY SIZE
126100              INTO WS-MSG
126200             END-STRING
126300             PERFORM LOG
126400     END-EVALUATE
126500
126600     .
126700
126800******************************************
126900*   INSERTION ITEM VAS                   *
127000******************************************
127100
127200 INSERER-ITEM-VAS.
127300
127400* CODE SYMETRIQUE A INSERER-ITEM-VEU
127500* PREPARER VARIABLES ITEMS
127600
127700     MOVE ID-VAS TO ITE-O-NO
127800     MOVE NUM-PROD-VAS TO ITE-P-NO
127900     MOVE QTE-ORDERED-VAS TO ITE-QUANTITY
128000
128100
128200* RECUPERER LE PRIX (DU FICHIER OU DE LA BASE)
128300
128400     MOVE SPACES TO WS-PU-STR
128500     MOVE 0 TO WS-PU-NUM
128600     IF PRICE-VAS NOT = SPACES
128700        DISPLAY 'PRIX FICHIER TROUVE : ' PRICE-VAS
128800        MOVE PRICE-VAS TO WS-PU-STR
128900        COMPUTE WS-PU-NUM = FUNCTION NUMVAL(WS-PU-STR) / 100
129000        MOVE WS-PU-NUM TO ITE-PRICE
129100        DISPLAY 'PRIX FICHIER : ' PRICE-VAS
129200        DISPLAY 'PRIX CONVERTI : ' ITE-PRICE
129300     ELSE
129400        DISPLAY 'PRIX MANQUANT -RECHERCHE EN BASE POUR : '
129500                 NUM-PROD-VAS
129600
129700     EXEC SQL            CLOSE CPROD             END-EXEC
129800     EXEC SQL            OPEN CPROD              END-EXEC
129900
130000        PERFORM FETCH-CPROD
130100        PERFORM TEST-SQLCODE
130200
130300        PERFORM UNTIL PRO-P-NO = NUM-PROD-VAS
130400                OR SQLCODE = 100
130500
130600                PERFORM FETCH-CPROD
130700                PERFORM TEST-SQLCODE
130800        END-PERFORM
130900
131000         IF SQLCODE = 0
131100            DISPLAY 'PRIX TROUVE EN BASE : ' PRO-PRICE
131200            DISPLAY 'PRIX PRO-PRICE AFFICHAGE :' PRO-PRICE
131300            DISPLAY 'PRIX PRO-PRICE VALEUR : [' PRO-PRICE ']'
131400            MOVE PRO-PRICE TO ITE-PRICE
131500         ELSE
131600            DISPLAY 'PAS DE PRIX DISPONIBLE POUR : ' NUM-PROD-VAS
131700            DISPLAY '--- PARAGRAPHE INSERTION ITEMS ---'
131800            MOVE SPACES TO WS-MSG
131900            MOVE SPACES TO WS-CONTEXT
132000            MOVE 1 TO WS-CONTEXT-LEN
132100            STRING 'INSERER ITEM VAS' DELIMITED BY SIZE
132200                   INTO WS-CONTEXT
132300                   WITH POINTER WS-CONTEXT-LEN
132400            END-STRING
132500            SUBTRACT 1 FROM WS-CONTEXT-LEN
132600
132700            STRING
132800             'ERREUR ' DELIMITED BY SIZE
132900             WS-CONTEXT(1:WS-CONTEXT-LEN) DELIMITED BY SIZE
133000             'PRIX NON TROUVE EN BDD' DELIMITED BY SIZE
133100             'POUR LE PRODUIT : '         DELIMITED BY SIZE
133200              NUM-PROD-VEU DELIMITED BY SIZE
133300              INTO WS-MSG
133400              PERFORM LOG
133500         END-IF
133600     END-IF
133700
133800
133900* CALCULER MONTANT LIGNE
134000
134100     COMPUTE WS-ITEM-AMOUNT = ITE-PRICE * ITE-QUANTITY
134200     DISPLAY 'CALCUL MONTANT : ' ITE-PRICE '*' ITE-QUANTITY
134300                             '=' WS-ITEM-AMOUNT
134400
134500* AJOUTER DANS ITEMS
134600
134700
134800     EXEC SQL
134900         INSERT INTO API7.ITEMS
135000                (O_NO,
135100                 P_NO,
135200                 QUANTITY,
135300                 PRICE
135400                 )
135500         VALUES (:ITE-O-NO,
135600                 :ITE-P-NO,
135700                 :ITE-QUANTITY,
135800                 :ITE-PRICE
135900                 )
136000     END-EXEC
136100
136200     MOVE 'INSERT ITEMS VEU' TO WS-MSG-SQL
136300     MOVE SQLCODE TO ED-SQLCODE
136400     PERFORM TEST-SQLCODE
136500
136600* SI TOUT EST BON, VALIDER L'INSERTION
136700* SINON, JOURNALISATION
136800
136900     EVALUATE TRUE
137000
137100        WHEN SQLCODE = ZERO
137200             ADD WS-ITEM-AMOUNT TO WS-ORDER-TOTAL-VAS
137300             MOVE 'O' TO WS-ITEM-INSERT-OK
137400             DISPLAY ' --- LECTURE ITEMS AJOUTES --- '
137500             DISPLAY ' COMMANDE VAS INSERE : ' ITE-O-NO
137600             DISPLAY ' ID DU PRODUIT :' ITE-P-NO
137700             DISPLAY ' QTE :' ITE-QUANTITY
137800             DISPLAY ' PRIX :' ITE-PRICE
137900
138000        WHEN SQLCODE = -803
138100             DISPLAY '  ITEM VEU DEJA EXISTANT : ' NUM-PROD-VAS
138200             MOVE SPACES TO WS-MSG
138300             MOVE SPACES TO WS-CONTEXT
138400             MOVE 1 TO WS-CONTEXT-LEN
138500             STRING 'INSERER ITEM VAS' DELIMITED BY SIZE
138600                    INTO WS-CONTEXT
138700                    WITH POINTER WS-CONTEXT-LEN
138800             END-STRING
138900             SUBTRACT 1 FROM WS-CONTEXT-LEN
139000
139100             STRING
139200               'ERREUR '                    DELIMITED BY SIZE
139300               WS-CONTEXT(1:WS-CONTEXT-LEN) DELIMITED BY SIZE
139400               'DOUBLON POUR ID : '         DELIMITED BY SIZE
139500                ID-VAS                      DELIMITED BY SIZE
139600                'AJOUT ITEM VEU ANNULE'     DELIMITED BY SIZE
139700               INTO WS-MSG
139800             END-STRING
139900             PERFORM LOG
140000
140100        WHEN OTHER
140200             DISPLAY '  ERREUR INSERT ITEM VEU : ' NUM-PROD-VAS
140300             DISPLAY '  SQLCODE : ' ED-SQLCODE
140400             MOVE SPACES TO WS-MSG
140500             MOVE SPACES TO WS-CONTEXT
140600             MOVE 1 TO WS-CONTEXT-LEN
140700             STRING 'INSERER ITEM VEU' DELIMITED BY SIZE
140800                    INTO WS-CONTEXT
140900                    WITH POINTER WS-CONTEXT-LEN
141000             END-STRING
141100             SUBTRACT 1 FROM WS-CONTEXT-LEN
141200
141300             STRING
141400              'ERREUR INSERT ITEM VEU :'   DELIMITED BY SIZE
141500              WS-CONTEXT(1:WS-CONTEXT-LEN) DELIMITED BY SIZE
141600              'ANOMALIE SQL'               DELIMITED BY SIZE
141700              INTO WS-MSG
141800             END-STRING
141900             PERFORM LOG
142000     END-EVALUATE
142100
142200     .
142300
142400******************************************
142500*      FINALISATION DES COMMANDES        *
142600******************************************
142700
142800 FINALISER-TOUTES-COMMANDES.
142900
143000* VERIFIER SI IL Y A DES COMMANDES A FINALISER
143100
143200     IF NB-CLIENTS = 0
143300        DISPLAY 'AUCUNE COMMANDE A FINALISER'
143400     END-IF
143500
143600
143700* PARCOURIR LA TABLES DES CLIENTS
143800
143900     PERFORM VARYING IDX-CLIENT FROM 1 BY 1
144000             UNTIL IDX-CLIENT > NB-CLIENTS
144100
144200      MOVE CLIENT-NO(IDX-CLIENT) TO ORD-C-NO
144300      MOVE CLIENT-TOTAL(IDX-CLIENT) TO WS-TOTAL-COMMANDES
144400
144500      DISPLAY '---------------------------------------------'
144600      DISPLAY 'COMMANDE TOTALE : ' WS-TOTAL-COMMANDES
144700
144800* RECUPERER LES INFORMATIONS DU CLIENT
144900
145000      EXEC SQL
145100         SELECT BALANCE
145200         INTO :CUS-BALANCE
145300         FROM API7.CUSTOMERS
145400         WHERE C_NO = :ORD-C-NO
145500      END-EXEC
145600
145700
145800      MOVE SQLCODE TO ED-SQLCODE
145900         PERFORM TEST-SQLCODE
146000         IF SQLCODE NOT = ZERO
146100             DISPLAY 'ERREUR LECTURE BALANCE CLIENT : ' ORD-C-NO
146200             MOVE ORD-C-NO TO WS-CLIENT-NUM
146300             MOVE SPACES TO WS-MSG
146400             MOVE SPACES TO WS-CONTEXT
146500             MOVE 1 TO WS-CONTEXT-LEN
146600             STRING 'FINALISATION COMMANDES' DELIMITED BY SIZE
146700                    INTO WS-CONTEXT
146800                    WITH POINTER WS-CONTEXT-LEN
146900             END-STRING
147000             SUBTRACT 1 FROM WS-CONTEXT-LEN
147100
147200             STRING
147300              'ERREUR '                       DELIMITED BY SIZE
147400              WS-CONTEXT(1:WS-CONTEXT-LEN)    DELIMITED BY SIZE
147500              'ERREUR LECTURE BALANCE CLIENT' DELIMITED BY SIZE
147600              INTO WS-MSG
147700             END-STRING
147800             PERFORM LOG
147900         END-IF
148000
148100* CALCULER LA NOUVELLE BALANCE
148200
148300     MOVE CUS-BALANCE TO WS-BALANCE-BASE
148400     DISPLAY 'BALANCE CLIENT DE BASE : ' WS-BALANCE-BASE
148500     MOVE WS-TOTAL-COMMANDES TO WS-BALANCE-TO-ADD
148600     DISPLAY ' MONTANT TOTAL A AJOUTER : ' WS-TOTAL-COMMANDES
148700     COMPUTE WS-BALANCE-UPDATE =
148800             WS-BALANCE-BASE + WS-TOTAL-COMMANDES
148900     DISPLAY ' BALANCE A JOUR APRES CALCUL :'
149000               WS-BALANCE-UPDATE
149100     MOVE WS-BALANCE-UPDATE TO CUS-BALANCE
149200
149300* METTRE A JOUR LA BALANCE DU CLIENT
149400
149500     EXEC SQL
149600         UPDATE API7.CUSTOMERS
149700            SET BALANCE = :CUS-BALANCE
149800          WHERE C_NO = :ORD-C-NO
149900     END-EXEC
150000
150100     MOVE 'UPDATE BALANCE CLIENT' TO WS-MSG-SQL
150200     PERFORM TEST-SQLCODE
150300
150400     EVALUATE TRUE
150500       WHEN SQLCODE = ZERO
150600            DISPLAY '    BALANCE CLIENT NUMERO : ' ORD-C-NO
150700            DISPLAY ' MONTANT AJOUTE : ' WS-TOTAL-COMMANDES
150800            DISPLAY ' BALANCE A JOUR : ' CUS-BALANCE
150900       WHEN OTHER
151000            DISPLAY '  ERREUR  BALANCE CLIENT   ' ORD-C-NO
151100            MOVE WS-TOTAL-COMMANDES TO ED-MONTANT
151200            MOVE ORD-C-NO TO WS-CLIENT-NUM
151300
151400             MOVE SPACES TO WS-MSG
151500             MOVE SPACES TO WS-CONTEXT
151600             MOVE 1 TO WS-CONTEXT-LEN
151700             STRING 'FINALISATION COMMANDES' DELIMITED BY SIZE
151800                    INTO WS-CONTEXT
151900                    WITH POINTER WS-CONTEXT-LEN
152000             END-STRING
152100             SUBTRACT 1 FROM WS-CONTEXT-LEN
152200
152300             STRING
152400              'ERREUR '                       DELIMITED BY SIZE
152500              WS-CONTEXT(1:WS-CONTEXT-LEN)    DELIMITED BY SIZE
152600              'ECHEC MISE A JOUR BALANCE'     DELIMITED BY SIZE
152700              'POUR LE CLIENT'                DELIMITED BY SIZE
152800              WS-CLIENT-NUM                   DELIMITED BY SIZE
152900              INTO WS-MSG
153000             END-STRING
153100             PERFORM LOG
153200     END-EVALUATE
153300     END-PERFORM
153400        .
153500
153600
153700**************************************************
153800*          CUMULATION DES VENTES                 *
153900**************************************************
154000
154100 CUMULER-VENTES.
154200
154300* CUMULATION DES QUANTITES VENDUES PAR PRODUIT
154400* TABLEAU DE VARIABLES TAB-VENTES
154500
154600     MOVE 'N' TO TROUVE
154700
154800     PERFORM VARYING IDX-VENTE FROM 1 BY 1
154900             UNTIL IDX-VENTE > NB-PROD-CUMUL OR TROUVE = 'O'
155000        IF TAB-PROD(IDX-VENTE) = NUM-PROD-ST
155100           IF LECTURE-VEU
155200              ADD QTE-ORDERED-VEU TO TAB-QTE-CUMUL(IDX-VENTE)
155300           ELSE
155400              ADD QTE-ORDERED-VAS TO TAB-QTE-CUMUL(IDX-VENTE)
155500           END-IF
155600           MOVE 'O' TO TROUVE
155700           DISPLAY 'CUMUL POUR : ' NUM-PROD-ST ':'
155800                               TAB-QTE-CUMUL(IDX-VENTE)
155900        END-IF
156000     END-PERFORM
156100
156200     IF TROUVE = 'N'
156300
156400*    NOUVEAU PRODUIT -> AJOUTER EN FIN DE TABLEAU
156500
156600        ADD 1 TO NB-PROD-CUMUL
156700        MOVE NUM-PROD-ST TO TAB-PROD(NB-PROD-CUMUL)
156800        IF LECTURE-VEU
156900           MOVE QTE-ORDERED-VEU TO TAB-QTE-CUMUL(NB-PROD-CUMUL)
157000        ELSE
157100           MOVE QTE-ORDERED-VAS TO TAB-QTE-CUMUL(NB-PROD-CUMUL)
157200        END-IF
157300        DISPLAY '-------------------------------------'
157400        DISPLAY 'NOUVEAU PRODUIT ' NUM-PROD-ST
157500                ' QTE : ' TAB-QTE-CUMUL(NB-PROD-CUMUL)
157600     END-IF
157700               .
157800
157900
158000***************************************************
158100*    CALCUL CUMULATION MONTANTS COMMANDES CLIENTS *
158200***************************************************
158300
158400* CUMULATION DES MONTANTS PAR CLIENT
158500* TABLEAU DE VARIABLES TAB-CLIENTS
158600
158700 CUMULER-MONTANT-CLIENT.
158800
158900         MOVE 'N' TO WS-CLIENT-TROUVE
159000         PERFORM VARYING IDX-CLIENT FROM 1 BY 1
159100                 UNTIL IDX-CLIENT > NB-CLIENTS
159200                       OR WS-CLIENT-TROUVE = 'O'
159300             IF CLIENT-NO(IDX-CLIENT) = WS-CLIENT-NUM
159400                MOVE 'O' TO WS-CLIENT-TROUVE
159500                IF LECTURE-VEU
159600                   ADD WS-ITEM-AMOUNT TO CLIENT-TOTAL(IDX-CLIENT)
159700                ELSE
159800                   ADD WS-ITEM-AMOUNT TO CLIENT-TOTAL(IDX-CLIENT)
159900                END-IF
160000             END-IF
160100         END-PERFORM
160200
160300         IF WS-CLIENT-TROUVE = 'N'
160400
160500*        NOUVEAU CLIENT
160600
160700            ADD 1 TO NB-CLIENTS
160800            MOVE WS-CLIENT-NUM TO CLIENT-NO(NB-CLIENTS)
160900            IF LECTURE-VEU
161000               MOVE WS-ITEM-AMOUNT TO CLIENT-TOTAL(NB-CLIENTS)
161100            ELSE
161200               MOVE WS-ITEM-AMOUNT TO CLIENT-TOTAL(NB-CLIENTS)
161300            END-IF
161400         END-IF
161500         .
161600
161700
161800***************************************************
161900*    CALCUL DES STOCKS ET MISE A JOUR REAPPRO     *
162000*                                                 *
162100*  STOCK = STOCK ACTUEL - QUANTITE TOTALE VENDUE  *
162200*       SI STOCK < SEUIL => LIGNE REAPPRO         *
162300***************************************************
162400
162500 CALCUL-STOCKS-CUMULES.
162600
162700     EXEC SQL CLOSE CPROD END-EXEC
162800     EXEC SQL OPEN CPROD END-EXEC
162900
163000     PERFORM FETCH-CPROD
163100     PERFORM TEST-SQLCODE
163200
163300* RECHERCHE DU PRODUIT DANS LE CURSEUR
163400
163500     PERFORM UNTIL PRO-P-NO = NUM-PROD-ST OR SQLCODE = 100
163600             PERFORM FETCH-CPROD
163700             PERFORM TEST-SQLCODE
163800     END-PERFORM
163900
164000     IF SQLCODE = 0
164100
164200* CALCUL DU NOUVEAU STOCK = STOCK ACTUEL - TOTAL VENDU
164300
164400       MOVE PRO-STOCK TO WS-STOCK-ACTUEL
164500       COMPUTE WS-STOCK-ACTUEL = WS-STOCK-ACTUEL - WS-QTE-TOTALE
164600       DISPLAY '----------------------------------------------'
164700       DISPLAY 'PRODUIT : ' NUM-PROD-ST
164800       DISPLAY '  STOCK AVANT : ' PRO-STOCK
164900       DISPLAY '  QTE VENDUE  : ' WS-QTE-TOTALE
165000       DISPLAY '  STOCK APRES : ' WS-STOCK-ACTUEL
165100       DISPLAY ' SEUIL MINIMUM STOCK :' SEUIL-PROD-ST
165200       MOVE WS-STOCK-ACTUEL TO PRO-STOCK
165300
165400* MISE A JOUR DES STOCKS DANS LA TABLE PRODUCTS
165500
165600       EXEC SQL
165700            UPDATE API7.PRODUCTS
165800                   SET STOCK = :PRO-STOCK
165900                   WHERE P_NO = :PRO-P-NO
166000       END-EXEC
166100
166200       MOVE 'UPDATE STOCK CUMULE' TO WS-MSG-SQL
166300       PERFORM TEST-SQLCODE
166400
166500     EVALUATE TRUE
166600       WHEN SQLCODE = ZERO
166700            DISPLAY ' STOCK POUR LE PRODUIT: ' PRO-P-NO
166800            DISPLAY ' A JOUR '
166900            DISPLAY ' NOUVEAU STOCK : ' PRO-STOCK
167000       WHEN OTHER
167100            DISPLAY ' ERREUR MISE A JOUR STOCK ' PRO-P-NO
167200
167300             MOVE SPACES TO WS-MSG
167400             MOVE SPACES TO WS-CONTEXT
167500             MOVE 1 TO WS-CONTEXT-LEN
167600             STRING 'MISE A JOUR STOCKS ' DELIMITED BY SIZE
167700                    INTO WS-CONTEXT
167800                    WITH POINTER WS-CONTEXT-LEN
167900             END-STRING
168000             SUBTRACT 1 FROM WS-CONTEXT-LEN
168100
168200             STRING
168300              'ERREUR '                       DELIMITED BY SIZE
168400              WS-CONTEXT(1:WS-CONTEXT-LEN)    DELIMITED BY SIZE
168500              'ECHEC MISE A JOUR STOCK'       DELIMITED BY SIZE
168600              'POUR LE PRODUIT'               DELIMITED BY SIZE
168700              PRO-P-NO                        DELIMITED BY SIZE
168800              INTO WS-MSG
168900             END-STRING
169000             PERFORM LOG
169100     END-EVALUATE
169200
169300
169400
169500* VERIFICATION SEUIL ET REAPPRO
169600
169700       IF PRO-STOCK < SEUIL-PROD-ST
169800          MOVE NUM-PROD-ST TO NUM-PROD-REA
169900          MOVE QTE-TO-ORD-ST TO QTE-TO-ORD-REA
170000          PERFORM FORMAT-DATE
170100          MOVE WS-DATE-FMT TO DATE-ORD-REA
170200          WRITE ENR-REA
170300          DISPLAY '  >>> REAPPRO GENERE   '
170400       END-IF
170500     END-IF
170600       .
170700
170800
170900**********************************************
171000*   REDACTION ERREURS DANS LE FICHIER LOG    *
171100**********************************************
171200
171300 LOG.
171400
171500     EXEC SQL
171600          SELECT USER
171700          INTO :WS-USER
171800          FROM SYSIBM.SYSDUMMY1
171900     END-EXEC
172000
172100     CALL 'LOGDATA' USING WS-MSG, WS-PGM, WS-USER
172200       .
172300
172400
172500***************************************************
172600*             FORMATAGE DES DATES                 *
172700***************************************************
172800
172900 FORMAT-DATE.
173000
173100     ACCEPT WS-DATE FROM DATE
173200
173300     MOVE '20'         TO WS-DATE-FMT(1:2)
173400     MOVE WS-DATE(1:2) TO WS-DATE-FMT(3:2)
173500     MOVE '-'          TO WS-DATE-FMT(5:1)
173600     MOVE WS-DATE(3:2) TO WS-DATE-FMT(6:2)
173700     MOVE '-'          TO WS-DATE-FMT(8:1)
173800     MOVE WS-DATE(5:2) TO WS-DATE-FMT(9:2)
173900     .
174000
174100
174200***************************************************
174300*           REDACTION ERREURS TEST SQL            *
174400***************************************************
174500
174600 TEST-SQLCODE.
174700       MOVE SQLCODE TO ED-SQLCODE
174800       EVALUATE TRUE
174900         WHEN SQLCODE = ZERO
175000              CONTINUE
175100         WHEN SQLCODE > ZERO
175200              DISPLAY 'WARNING - ' WS-MSG-SQL ': ' ED-SQLCODE
175300         WHEN OTHER
175400              DISPLAY 'ANOMALIE - '  WS-MSG-SQL ': ' ED-SQLCODE
175500              PERFORM ABEND-PROG
175600       END-EVALUATE.
175700
175800
175900 ABEND-PROG.
176000     DISPLAY 'ANO !!!!'
176100     COMPUTE WS-ANO = 1 / WS-ANO
176200     .
176300
176400
176500***************************************************
176600*           FERMETURE DES FICHIERS                *
176700***************************************************
176800
176900  FERMER-FICHIERS.
177000
177100      CLOSE F-VEU F-VAS F-ST F-REA
177200      .
177300
